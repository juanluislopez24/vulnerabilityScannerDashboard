import shodan
import sys
import json

# Configuration
API_KEY = ''
with open('api-key.json', 'r') as file:
    API_KEY = json.load(file)['key']

def searchShodan(key, query, limit, output_file, output_file_ipv4):
    try:
        # Setup API
        api = shodan.Shodan(key)
        counter = 0
        dictionary = {'matches': []}
        ip_list = {'ipv4': []}
        for banner in api.search_cursor(query):
            ip_addr = banner['ip_str']
            print('Found IPv4 address: {}'.format(ip_addr))
            dictionary['matches'].append(banner)
            ip_list['ipv4'].append(ip_addr)
            counter += 1
            if counter >= limit:
                break
        with open(output_file, 'w') as outfile:
            json.dump(dictionary, outfile, indent=4)
        with open(output_file_ipv4, 'w') as outfile_ipv4:
            json.dump(ip_list, outfile_ipv4, indent=4)
        return True
    except Exception as e:
        print('Error: {}'.format(e))
        return False

def collectSummary(key, query, facet_names, output_file):
    try:
        api = shodan.Shodan(key)
        result = api.count(query, facets=facet_names)
        for facet in result['facets']:
            print(facet)
    except (Exception) as e:
        print('Error: {}'.format(e))
        return False

#searchShodan(API_KEY, 'country:GT product:"Apache httpd"', 3000, 'gt-apache.json', 'gt-apache-ipv4.json')
#searchShodan(API_KEY, 'country:"GT" product:"Apache httpd" version:"2.2.15"', 3000, 'gt-apache-v2215.json', 'gt-apache-v2215-ipv4.json')

FACETS = [
    ('asn', 10),
    ('city' ,10),
    ('device', 10),
    ('domain', 10),
    ('isp', 10),
    ('org', 10),
    ('os', 10),
    ('port', 10),
    ('http.component', 10),
    ('http.component_category', 10),
    ('ssl.version', 10),
    ('ssl.cert.expired', 10)
]

collectSummary(API_KEY, 'country:"GT"', FACETS, 'test.json')